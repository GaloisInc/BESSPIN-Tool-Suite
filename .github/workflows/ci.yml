name: CI
on: [push, pull_request]

jobs:
  Push:
    runs-on: self-hosted
    if: github.event_name == 'push'
    strategy:
      matrix:
        os: [unix, freertos]
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - uses: ./.github/docker
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          run: nix-shell --command "./ci/fett-ci.py runOnPush-${{ matrix.os }} push-${{ matrix.os }}-${{ github.sha }}"
      - if: always()
        uses: actions/upload-artifact@v2
        with:
          name: push-${{ github.sha }}
          path: "*-push-${{ matrix.os }}-${{ github.sha }}"

  DevPR-unix:
    runs-on: self-hosted
    strategy:
      matrix:
        os: [unix]
        index: [1, 2]

    if: "github.event_name == 'pull_request' && github.base_ref == 'develop'"
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - uses: ./.github/docker
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          run: nix-shell --command "./ci/fett-ci.py runDevPR-${{ matrix.os }} devPR-${{ matrix.os }}-${{ github.sha }} -i ${{ matrix.index }} -N 2"
      - if: always()
        uses: actions/upload-artifact@v2
        with:
          name: devPR-${{ github.sha }}
          path: "*-devPR-${{ matrix.os }}-${{ github.sha }}"

  DevPR-freertos:
    runs-on: self-hosted
    strategy:
      matrix:
        os: [freertos]
        index: [1]

    if: "github.event_name == 'pull_request' && github.base_ref == 'develop'"
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - uses: ./.github/docker
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          run: nix-shell --command "./ci/fett-ci.py runDevPR-${{ matrix.os }} devPR-${{ matrix.os }}-${{ github.sha }} -i ${{ matrix.index }} -N 1"
      - if: always()
        uses: actions/upload-artifact@v2
        with:
          name: devPR-${{ github.sha }}
          path: "*-devPR-${{ matrix.os }}-${{ github.sha }}"
