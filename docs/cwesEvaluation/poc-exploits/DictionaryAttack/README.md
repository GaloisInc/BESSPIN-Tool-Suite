# Dictionary Attack

This document describes an attack example that falls under the SSITH
vulnerability class of permission, privileges, and access control
(PPAC):

> This vulnerability allows execution of unauthorized operations in a
> system. A privilege vulnerability can allow inappropriate access to
> system privileges. A permission vulnerability can allow
> inappropriate permission to perform functions. An access
> vulnerability can allow inappropriate control of the authorizing
> policies for the hardware.

## What Is A Dictionary Attack?

The most common method of authenticating a user in a computer system is through a password. This method may continue for several more decades because it is the most convenient and practical way of authenticating users. However, this is also the weakest form of authentication, because users frequently use ordinary words as passwords \[[ref](https://www.techopedia.com/definition/1774/dictionary-attack)\]. 

A dictionary attack is a technique or method used to breach the computer security of a password-protected machine or server. A dictionary attack attempts to defeat an authentication mechanism by systematically entering each word in a dictionary as a password or trying to determine the decryption key of an encrypted message or document \[[ref](https://www.techopedia.com/definition/1774/dictionary-attack)\].

Since most passwords are chosen by users, it stands to reason that most passwords are or contain common words. There are a little over a million words in the English language, while there are 308,915,776 possible combinations of 6 letters. Most attackers will take this into account when attempting to intrude on your system, and make use of word lists in combination with common password lists when trying to guess passwords \[[ref](https://www.hacksplaining.com/glossary/dictionary-attacks)\].

## Twitter "happiness" Breach in 2009

In January 2009, an 18-year-old hacker with a history of celebrity pranks has admitted to the hijacking of multiple high-profile Twitter accounts, including then-President-Elect Barack Obama's, and the official feed for Fox News \[[ref](https://www.wired.com/2009/01/professed-twitt/)\].

The attacker was able to gain administrator access to a Twitter server because the server did not restrict the number of login attempts. The attacker targeted a member of Twitter's support team and was able to successfully guess the member's password using a brute force with a large number of common words. After gaining access as the member of the support staff, the attacker used the administrator panel to gain access to 33 accounts that belonged to celebrities and politicians. Ultimately, fake Twitter messages were sent that appeared to come from the compromised accounts \[[ref](https://cwe.mitre.org/data/definitions/287.html)\].

The hacker gained entry to Twitter's administrative control panel by pointing an automated password-guesser at a popular user's account. The user turned out to be a member of Twitter's support staff, who'd chosen the weak password **"happiness"**. *Cracking the site was easy, because Twitter allowed an unlimited number of rapid-fire log-in attempts* \[[ref](https://cwe.mitre.org/data/definitions/287.html)\].

This started when the attacker randomly targeted the Twitter account belonging to a woman identified as "Crystal." He found Crystal only because her name had popped up repeatedly as a follower on a number of Twitter feeds. "I thought she was just a really popular member," he said. Using a simple tool he authored himself, he launched a dictionary attack against the account, automatically trying English words. He let the program run overnight, and when he checked the results the next morning, he found he was in Crystal's account. That is when he realized that Crystal was a Twitter staffer, and he now had the ability to access any other Twitter account by simply resetting an account holder's password through the administrative panel. He said he decided not to use other hacked accounts personally. Instead he posted a message to a forum for hackers, offering access to any Twitter account by request. He also posted [this video](https://www.youtube.com/watch?v=IKNbggNJMVI&feature=youtu.be) he made of his hack to prove he had administrative access to Twitter \[[ref](https://cwe.mitre.org/data/definitions/287.html)\].

The screenshot below shows his access to the Twitter administrative panel from "Crystal" profile.

![fig:adminScreenshot](../../../.figures/twitterAdminPanelOnAdmin.png "Admin panel from admin user")

The next screenshot shows the administrative panel on a random user "emo". It shows the ability to *reset password*.

![fig:userScreenshot](../../../.figures/twitterAdminPanelOnUser.png "Admin panel from any user")

When he pressed on it, it gave him a new password in text format as shown below. He then used this to log in to any user, and even change their email from their profile settings, and thus blocking their own access.

![fig:resetPassword](../../../.figures/twitterResetPassword.png "Password reset in text format")

## The Code Exploit

For SSITH, we implemented an example of a dictionary attack to access root privileges from a local non-root user. In Linux, the `su` command is used to run commands with a substitute user. Using it without arguments, or explicitly using it as `su root` gives any user access to all administrative privileges after password authentication. Linux Debian, by default, does not limit the number of authentication attempts to substitute users.

In order to shorten the amount of time needed to run this exploit, we assumed that the root user chose a Star Wars planet as their password. A non-root user uses a dictionary attack by trying out the Star Wars planets one-by-one from a list until given access. 

The bash script executed on non-root user is as follows:

```bash
#Loading the dictionary
dictFile="starWarsPlanets.dict"
if [ ! -f $dictFile ]; then
	echo "Error in $0: Cannot find <$dictFile>."
	exit 1
fi
StarWarsPlanetsDict=$(cat $dictFile)

#The dictionary attack
for planet in $StarWarsPlanetsDict; do
	echo ">> Trying <$planet>..."
	su root
done
```

Another automated interacting script reads which planet has to be tried, then attempts to breach. The code in action is shown below: 	

![fig:runScreenshot](../../../.figures/dictionaryAttack.png "Dictionary attack in action")

We can see that when the user enters *"Besspin"*, they were able to access a root shell. Even after six failed attempts.

## Fixing The Vulnerable Code

This vulnerability can be fixed by using a [PAM](https://en.wikipedia.org/wiki/Pluggable_authentication_module) (pluggable authentication module) policy that requires the [pam_tally2](https://manpages.debian.org/jessie/libpam-modules/pam_tally2.8.en.html) login counter (tallying) module for authentication.

The authentication policy defined in `/etc/pam.d/common-auth` is included by all system calls PAM policies that requires authentication, including `su`. The following line should be inserted to this policy before the inclusion of authentication PAM module [(pam_unix)](https://manpages.debian.org/jessie/libpam-modules/pam_unix.8.en.html):
```
auth    required    pam_tally2.so    deny=nAllowedAttempts    even_deny_root
``` 
where *nAllowedAttempts* is the number of failed attempts allowed before blocking the authentication attempts. By doing so, the system becomes secure as follows (using deny=3):

![fig:runScreenshotBlocked](../../../.figures/dictionaryAttackBlocked.png "Blocked dictionary attack in action")

## CWE Discussion

The [NIST Bugs Framework](https://samate.nist.gov/BF/) (BF) provides a succinct 
language for classifying software bugs, such as permission, privileges, and access control.
We can describe this example using the BF's terminology for the *control of interaction frequency* (CIF) class.
Some attributes are not applicable (N/A) because this is a theoretical rather
than an applied example.   

* Causes: Failure to limit number of interactions.
* Attributes:
    * Interaction: Authentication attempt.
    * Number: Specified number.
    * Unit: Event.
    * Actor: Unauthorized user.

Hardware could be made secure against this vulnerability by protecting the authentication system calls from being called and failing multiple consecutive times. 

* The dictionary attack exploit is related to the following CWEs:
	- [CWE-799](https://cwe.mitre.org/data/definitions/799.html): Improper Control of Interaction Frequency.
	- [CWE-307](https://cwe.mitre.org/data/definitions/307.html): Improper Restriction of Excessive Authentication Attempts.
	- [CWE-837](https://cwe.mitre.org/data/definitions/837.html) Improper Enforcement of a Single, Unique Action. This is in case the system would allow only a single authentication attempt.
	- [CWE-284:](https://cwe.mitre.org/data/definitions/284.html) Improper Access Control. Access control involves the use of several protection mechanisms such as authentication (proving the identity of an actor) and authorization (ensuring that a given actor can access a resource).
	- [CWE-287:](https://cwe.mitre.org/data/definitions/287.html) Improper Authentication.
	- [CWE-304:](https://cwe.mitre.org/data/definitions/304.html) Missing Critical Step in Authentication. This is further described as: authentication techniques should follow the algorithms that define them exactly, otherwise authentication can be bypassed or more easily subjected to brute force attacks
	- [CWE-521:](https://cwe.mitre.org/data/definitions/521.html) Weak Password Requirements.
	- [CWE-592:](https://cwe.mitre.org/data/definitions/592.html) Authentication Bypass Issues.
	- [CWE-285:](https://cwe.mitre.org/data/definitions/285.html) Improper Authorization.
	- [CWE-863:](https://cwe.mitre.org/data/definitions/863.html) Incorrect Authorization.

* Note that the twitter example shown above is related to the following CWEs as well:
	- [CWE-257:](https://cwe.mitre.org/data/definitions/257.html) Storing Passwords in a Recoverable Format. 
	- [CWE-308:](https://cwe.mitre.org/data/definitions/308.html) Use of Single-factor Authentication.
	- [CWE-309:](https://cwe.mitre.org/data/definitions/309.html) Use of Password System for Primary Authentication.
	- [CWE-522:](https://cwe.mitre.org/data/definitions/522.html) Insufficiently Protected Credentials.
	- [CWE-523:](https://cwe.mitre.org/data/definitions/523.html) Unprotected Transport of Credentials.
	- [CWE-640:](https://cwe.mitre.org/data/definitions/640.html) Weak Password Recovery Mechanism for Forgotten Password.
	- [CWE-798:](https://cwe.mitre.org/data/definitions/798.html) Use of Hard-coded Credentials

## Running The Codes

There are two configurable parameters:
- `poc_dictionaryAttack_rootPassword`: Which planet is the actual root password. Choose one from [this list](./2_PPAC/dictionaryAttack/starWarsPlanets.dict) in order to attempt a breach.
- `poc_dictionaryAttack_usePamTally`: The switch to enable the `pam_tally2` module, and thus blocking the exploit. Note that this is just an example, so using this option will block the root user which will render shutting the OS cleanly not feasible, and thus cause the testgen to terminate erroneously.



