#include <stdio.h>
#include <stdlib.h>

#define POC_PADDINGLEAKAGE_SECRET 0x1A2B3C4D

#if defined(BESSPIN_FREERTOS) && defined(BESSPIN_FPGA)
  #include "FreeRTOS.h"
  #define MALLOC pvPortMalloc
#else
  #define MALLOC malloc
#endif

struct unpaddedStruct { //only 9 bytes, will be padded to 12
  int a; //4 bytes
  char b; //1 byte
  int c; //4 bytes
};

int secretTask ();
int sendToPublicTask ( struct unpaddedStruct *payload );
void printByte (int *xInt);

/* secretTask writes secret to memory, then writes a struct to the same
   memory location. It sends a copy of that struct to publicTask,
   which leads to leakage of the secret. */

int secretTask () {
	printf("***** Within the secret task *****\n");
	/* Allocate memory for secret */ 
	int* secret_mem = (int *) MALLOC ( 3 * sizeof( int ) );
		
	/* Write secret */
	int secretLoad[3] = { 0xffffffff, POC_PADDINGLEAKAGE_SECRET, 0xffffffff };
	printf ("The secret = "); printByte (&secretLoad[1]);

	if( secret_mem != NULL ) {
		secret_mem = secretLoad;
	} else {
		printf( "Memory could not be allocated for secretLoad\n" );
		return 1;
	}	

	/* Check that secret is same size as struct unpaddedStruct */	
	if (sizeof( secretLoad ) != sizeof( struct unpaddedStruct )) {
		printf ("Error in paddingLeakage.c: size of secretLoad does not equal the size of the struct.");
		return 1;
	}

	/* Cast pointer from int pointer to struct pointer */ 
	struct unpaddedStruct* struct_mem = (struct unpaddedStruct *) secret_mem;

	/* Write struct to allocated memory */ 
	if( struct_mem != NULL ) {
		struct_mem->a = 1;
		struct_mem->b = 2;
		struct_mem->c = 3;
	} else {
		printf( "Memory could not be allocated for struct\n" );
        return 1;
	}

	/* Send data to Task2 using queue, which queues by copy */
	printf ("New value to send (not a secret) = %d\n", struct_mem->b);
	int pStatus = sendToPublicTask (struct_mem);
	if( pStatus != 0 ) {
		printf( "Could not send to the queue.\n" );
		return 1;
	}
 
	return 0;
}

/* The public task receives struct and reveals leakage through padding bytes */
int sendToPublicTask ( struct unpaddedStruct *payload ) {
	printf("***** Within the public task *****\n");
	/* Print struct, including padding bytes */ 
	if( payload != NULL ) {
		printf ("The whole word publicly accessed = "); printByte (&payload->b);	
	} else {
		printf( "Could not receive from the queue.\n" );
		return 1;
	}
    return 0;
}

void printByte (int *xInt) {
	for (int i = 3; i >= 0; i--) {
		unsigned char part = ((*xInt)>>(i*8))&0xFF;
	    printf("%02X", part);
	  }
	 printf ("\n");
}

int main() {
	printf("\n>>>>>Starting <paddingLeakage>: a poc-exploit for <informationLeakage>:\n");

	int retSecret = secretTask ();
	if (retSecret != 0) {
		printf ("Error in executing paddingLeakage.\n");
		return 1;
	}

	printf(">>>>>End of <paddingLeakage>: a poc-exploit for <informationLeakage>.\n");
	return 0;
}
