<!--

"The Objective - stop the driver from reaching the airport"

-->
<template>
  <div id="hack08">
      <video :class="webcamEnabled ? 'webcamFeed' : ''" autoplay="true" id="videoElement" loop></video>
      <div id="bg"></div>
      <button :class="[!brakeECUOn ? 'hack08-brakes-btn-active' : '', 'hack08-brakes-btn', 'img-btn']" @click="toggleBrakes()">
      </button>

      <button :class="[!acceleratorNormal ? 'hack08-accel-btn-active' : '', 'hack08-accel-btn', 'img-btn']" @click="toggleAccel()">
      </button>

      <button :class="[!lkaOn ? 'hack08-steer-btn-active' : '', 'hack08-steer-btn', 'img-btn']" @click="toggleSteering()">
      </button>

      <button :class="[!transDrive ? 'hack08-trans-btn-active' : '', 'hack08-trans-btn', 'img-btn']" @click="toggleTrans()">
      </button>

      <button v-if="clickCount >= 1" @click="next()" class="hack08-next-btn img-btn"></button>
  </div>
</template>

<style scoped>
  #bg {
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_noBTN.png');
    height: 100vh;
    width: 100vw;
    position: absolute;
    top: 0;
    left: 0;
  }
  .webcamFeed {
    position: absolute;
    margin: auto;
    top: 950px;
    left: 75px;
    height: 670px;
  }
  #hack08 {
    height: 1920px;
    width: 1080px;
    text-align: center;
  }

  .hack08-brakes-btn {
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_ecu_btnON.png');
    width: 360px;
    height: 200px;
    top: 462px;
    left: 180px;
  }
  .hack08-brakes-btn:active, .hack08-brakes-btn-active {
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_ecu_btnOFF.png');
    background-position-y: -25px;
    background-position-x: -25px;
  }

  .hack08-accel-btn {
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_accel_btnNORM.png');
    width: 360px;
    height: 200px;
    top: 462px;
    left: 540px;
  }
  .hack08-accel-btn:active, .hack08-accel-btn-active {
    background-position-y: -25px;
    background-position-x: -25px;
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_accel_btn100.png');
  }


  .hack08-steer-btn {
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_laneAssist_btn.png');
    width: 360px;
    height: 200px;
    top: 700px;
    left: 180px;
  }
  .hack08-steer-btn:active, .hack08-steer-btn-active {
    background-position-y: -25px;
    background-position-x: -25px;
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_laneAssist_btnHIT.png');
  }

  .hack08-trans-btn {
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_tran_btnDRIVE.png');
    width: 360px;
    height: 200px;
    top: 700px;
    left: 540px;
  }
   .hack08-trans-btn-active, .hack08-trans-btn:active {
    background-position-y: -25px;
    background-position-x: -25px;
    background-image: url('/hack08_criticalExploit/hack08_criticalExploit_tran_btnNEUT.png');
  }

  .hack08-next-btn {
    background-image: url('/hack05_infoAttempt/hack05_infoAttempt_btn.png');
    width: calc(716px * .7);
    height: calc(272px * .7);
    background-size: 70%;
    top: 1660px;
    left: 340px;
  }
  .hack08-next-btn:active {
    background-image: url('/hack05_infoAttempt/hack05_infoAttempt_btnHIT.png');
  }

</style>


<script>
  const electron = require('electron')
  const ipc = electron.ipcRenderer;

  const hacks = {
    NONE: 0,
    BRAKES: 1,
    STEER: 2,
    TRANS: 3,
    ACCEL: 4,
  }

  const transHackSrc = "/videos/hack08_criticalExploit TRANS.webm"
  const accelHackSrc = "/videos/hack08_criticalExploit ACCELERATOR.webm"
 
  export default {
    name: 'Hack08_CriticalExploit',
    props: {
    },
    data() {
      return {
        brakeECUOn: true,
        acceleratorNormal: true,
        lkaOn: true,
        transDrive: true,
        webcamEnabled: false,
        clickCount: 0,
        poller: setInterval(() => { this.pollState() }, 500)
      }
    },
    mounted() {
      ipc.on('zmq-results',(event, q) => {
        q.forEach(item => {
          if (item.func == 'critical_exploit' && item.status == 200) {
            if(item.args == 'brakes') {
              this.brakeECUOn = item.retval;
            } else if (item.args == 'throttle') {
              this.acceleratorNormal = item.retval;
            } else if (item.args == 'lkas') {
              this.lkaOn = item.retval;
            } else if (item.args == 'transmission') {
              this.transDrive = item.retval;
            }
          }
          if(item.func == 'hack08_next' && item.status == 200) {
            this.$router.push({ name: 'hack09_protect' });
          }
        });
      });
      

    },
    unmounted() {
      clearInterval(this.poller);
    },
    methods: {
      enableWebcamFeed(feed_id) {
        var video = document.querySelector("#videoElement");
        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ video: true })
          .then( (stream) => {
            video.srcObject = stream;
          })
          .catch( () => {
            console.log("Unable to initialize webcam feed ", feed_id);
          });
        }
      },

      // The video feed on this page has 5 different states.
      // 1. No hack selected
      // 2. Brakes (Webcam Feed)
      // 3. Steering (Webcam Feed)
      // 4. Transmission
      // 5. Accelerator
      swapVideoFeed(feed_id) {
        this.webcamEnabled = false;
        var video = document.querySelector("#videoElement");
        if(feed_id == hacks.STEER || feed_id == hacks.BRAKES) {
          this.webcamEnabled = true;
          this.enableWebcamFeed(feed_id);
          if (feed_id == hacks.STEER) {
            ipc.send('atem-switch', 1);
          } else {
            ipc.send('atem-switch', 2);
          }
        } else if(feed_id == hacks.TRANS) {
          video.srcObject = null;
          video.src =  transHackSrc;
        } else if(feed_id == hacks.ACCEL) {
          video.srcObject = null;
          video.src = accelHackSrc;
        }
      },
      next() {
        ipc.send('button-pressed', 'hack08_next', []);
        console.log('button-pressed', 'hack08_next',{});
      },
      pollState() {
        ipc.send('zmq-poll', []);
      },
      toggleBrakes() {
        this.clickCount++;
        console.log("[click] brakeECUOn = " + this.brakeECUOn);
        ipc.send('button-pressed', 'critical_exploit', 'brakes');
        this.swapVideoFeed(hacks.BRAKES);
      },
      toggleAccel() {
        this.clickCount++;
        console.log("[click] acceleratorNormal = " + this.acceleratorNormal);
        ipc.send('button-pressed', 'critical_exploit', 'throttle');
        this.swapVideoFeed(hacks.ACCEL);
      },
      toggleSteering() {
        this.clickCount++;
        console.log("[click] lkaOn = " + this.lkaOn);
        ipc.send('button-pressed', 'critical_exploit', 'lkas');
        this.swapVideoFeed(hacks.STEER);
      },
      toggleTrans() {
        this.clickCount++;
        console.log("[click] transDrive = " + this.transDrive);
        ipc.send('button-pressed', 'critical_exploit', 'transmission');
        this.swapVideoFeed(hacks.TRANS);
      }
    }
  };
</script>
